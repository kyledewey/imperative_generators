It would probably be cleaner to do this directly with built-in generators, but I don't understand them well enough to be able to do this at the moment.
Adding in do-style notation (e.g., with [`burrito`](https://github.com/pelotom/burrido)) would probably also improve clarity, though with proper use of JavaScript's built-in generators this might not be necessary.
